<!DOCTYPE html>
<html>
<head>
    <title>angular edit drag or click</title>
    <script type="text/javascript" src="../../bower_components/angular/angular.js"></script>
    <script type="text/javascript" src="../../bower_components/angular-bootstrap/ui-bootstrap-tpls.js"></script>
   

    <script type="text/javascript" src='../../bower_components/codemirror/lib/codemirror.js'></script>
    <script type="text/javascript" src='../../bower_components/angular-ui-codemirror/ui-codemirror.js'></script>
    <script type="text/javascript" src='../../bower_components/codemirror/mode/yaml/yaml.js'></script>
    <script type="text/javascript" src='../../public/javascripts/zxx.drag.1.0.js'></script>


    <script type="text/javascript" src="../../bower_components/ace-builds/src-min-noconflict/ace.js"></script>
    <script type="text/javascript" src="../../bower_components/angular/angular.js"></script>
    <script type="text/javascript" src="../../bower_components/angular-ui-ace/ui-ace.js"></script>

    <link rel="stylesheet" type="text/css" href="../../bower_components/codemirror/lib/codemirror.css">
    <link rel="stylesheet" type="text/css" href="http://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="../../bower_components/angular-bootstrap/ui-bootstrap-csp.css">
    <style type="text/css">
        .item {
            position: relative;
            margin: 5px;
            border: 1px solid #ccc;
        }

        .ace_editor {
            height: 200px;
        }
    </style>
</head>
<body ng-app='myApp'>
<div ng-controller='myCtrl' class="container-fluid">
    <div class="row">
        <div class="col-sm-8">
            <textarea class="form-control" style="height:100px;" id="mytextarea" ng-model="text"></textarea>
        </div>
        <div class="col-sm-4">
            <h5>textarea - 点击</h5>
            <div class="item" ng-repeat="d in datas" ng-click="test(d.data)">{{d.name}} : {{d.data}}</div>
        </div>
    </div>
    <hr>

    <div class="row">
        <div class="col-sm-8">
            <textarea class="form-control" style="height:100px;" ng-model="text"></textarea>
        </div>
        <div class="col-sm-4">
            <h5>textarea - 拖拽</h5>
            <div class="item" onclick="startDrag(this, this)" style="cursor: move;">代码块</div>
        </div>
    </div>
    <hr>

    <div class="row">
        <div class="col-sm-8">
            <ui-codemirror ui-codemirror-opts='cmOptionDrag'></ui-codemirror>
        </div>
        <div class="col-sm-4">
            <h5>CodeMirror - 拖拽</h5>
            <div class="item" onclick="startDrag(this, this)" style="cursor: move;">代码块</div>
        </div>
    </div>
    <hr>

    <div class="row">
        <div class="col-sm-8">
            <ui-codemirror ui-codemirror-opts="cmOptionClick"></ui-codemirror>
        </div>
        <div class="col-sm-4">
            <h5>CodeMirror - 点击</h5>
            <div class="item" ng-repeat="d in datas" ng-click="insert(d.data)" style="cursor:pointer;">{{d.name}} : {{d.data}}</div>
        </div>
    </div>

    <div class="row">
        <div class="col-sm-8">
            <div ui-ace="{
  useWrapMode : true,
  showGutter: false,
  theme:'twilight',
  mode: 'xml',
  firstLineNumber: 5,
  onLoad: aceLoaded,
  onChange: aceChanged
}"></div>
        </div>
        <div class="col-sm-4">
           ace-editor
        </div>
    </div>

</div>
<script type="text/javascript">
    angular.module('myApp', ['ui.bootstrap', 'ui.codemirror', 'ui.ace'])
    .controller('myCtrl', function($scope, $window) {

        $scope.text = "version: '1'\n"+
            "kind: appstack\n"+
            "metadata:\n"+
            "  name: 3-layer-appstack # 应用名称 (必填, 可修改, 长度1-40)\n"+
            "  description: xxxxxx # 应用描述 (可选,可修改, 长度0-255)\n"+
            "  type: 系统  # 应用类型 (必填, 可修改，下拉框)\n"+
            "  url: http://11.1.1.1/gateway # (必填)\n"+
            "  label:\n"+
            "    projectId: asdfd-asdf-asdf # (必填)\n"+
            "    farmId: 123-adsf-123 # (必填)\n"+
            "    tenantId: 123-adsf-123 # (必填)\n"+
            "    serviceInstanceId: 123 # (必填)";

        $scope.cmOptionDrag = {
            lineNumbers: true,
            autofocus: true,
            onLoad: function(cm) {
                cm.setSize('auto', '100px');
                doc = cm.getDoc();
                doc.setValue($scope.text);
            }
        };

        $scope.cmOptionClick = {
            lineNumbers: true,
            indentWithTabs: true,
            autofocus: true,
            onLoad: function(cm) {
                cm.setSize('auto','100px');

                doc = cm.getDoc();
                doc.setValue($scope.text);

                cm.on('change', function() {
                    //console.log(doc, doc.getValue());
                    //doc.replaceSelection("插入的内容");
                    console.log(doc.getValue());
                });

                cm.on('mousedown', function(){
                    //console.log('down');
                });

                cm.on('blur', function() {

                    setTimeout(function(){
                        if ($scope.insertText) {
                            doc.replaceSelection($scope.insertText);
                            $scope.insertText = '';
                            cm.focus();
                        }
                     },300);

                });
            }
        };

        $scope.datas = [{
            'name': '代码1',
            'data': 'var a = 1;'
        },{
            'name': '代码2',
            'data': 'function sum(){};'
        },{
            'name': '代码3',
            'data': 'console.log(123);'
        }];

        $scope.insert = function(str) {
            $scope.insertText = str;
        };

        $scope.test = function(str) {
            var tc = document.getElementById("mytextarea");
            var tclen = tc.value.length; 
            tc.focus(); 
            if(typeof document.selection != "undefined") { 
                document.selection.createRange().text = str; 
            } else { 
                tc.value = tc.value.substr(0,tc.selectionStart)+str+tc.value.substring(tc.selectionStart,tclen); 
            } 
        } 
        
    })
    .directive('dragItem', function() {
        return {
            restrict: 'A',
            replace: true,
            template: '<div class="item" ng-repeat="d in datas">{{d.name}}</div>',
            link: function(scope, elem, attrs) {
                console.log(elem, elem[0]);
                attrs.style = {
                    cursor: 'move',
                    position: 'relative',
                    border: '1px solid #ccc',
                };
                startDrag(elem, elem);
            }
        }
    });

</script>
</body>
</html>